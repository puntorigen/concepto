'use strict';(function(x,h){"object"===typeof exports&&"undefined"!==typeof module?module.exports=h():"function"===typeof define&&define.amd?define(h):(x="undefined"!==typeof globalThis?globalThis:x||self,x.concepto=h())})(this,function(){function x(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable}));c.push.apply(c,d)}return c}function h(a){for(var b=1;b<arguments.length;b++){var c=
null!=arguments[b]?arguments[b]:{};b%2?x(Object(c),!0).forEach(function(b){var d=c[b];b in a?Object.defineProperty(a,b,{value:d,enumerable:!0,configurable:!0,writable:!0}):a[b]=d}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(c)):x(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}return a}function y(a,b,c,d,e,g,f){try{var h=a[g](f),m=h.value}catch(v){c(v);return}h.done?b(m):Promise.resolve(m).then(d,e)}
function k(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function g(a){y(h,d,e,g,f,"next",a)}function f(a){y(h,d,e,g,f,"throw",a)}var h=a.apply(b,c);g(void 0)})}}function A(a,b){var c=a;if("string"===typeof c){c={};a=a.split(",");for(var d in a)c[a[d]]=b}else for(var e in c)c[e]=b;return c}function t(a,b){var c=!0,d;for(d of b.split(","))if(!0!==a[d]){c=!1;break}return c}function E(a,b){var c=!0;if(b.toString()!==a.toString())if("number"===typeof b)a==b?c=!0:a!=b&&(c=
!1);else if("string"===typeof b)if(-1==b.indexOf(",")&&"<"==b.charAt(0))a>=parseInt(b.replace("<",""))&&(c=!1);else if(-1==b.indexOf(",")&&">"==b.charAt(0))a<=parseInt(b.replace(">",""))&&(c=!1);else if(-1==b.indexOf(",")&&b!=a.toString())c=!1;else{var d=b.split(",");if(-1==b.indexOf("<")&&-1==b.indexOf(">")&&d.includes(a))c=!0;else if(-1!=b.indexOf("<")||-1!=b.indexOf(">"))for(var e of d)if(">"==e.charAt(0)){if(a<=parseInt(e.replace(">",""))){c=!1;break}}else if("<"==e.charAt(0)&&a>=parseInt(e.replace("<",
""))){c=!1;break}}else c=!1;return c}function B(a,b){return b.split(".").reduce((a,b)=>a[b],a)}function w(){return new Promise(a=>{setImmediate(()=>a())})}class z{constructor(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(2!=arguments.length||"object"===typeof arguments[0])throw Error("fatal error! missing file parameter for parser!");var c=require("open_console");this.x_config=h(h({},{class:"concepto",console:!0,debug:!1,cache:!0,dsl_git:!0,prefix:""}),b);this.x_console=new c({silent:!this.x_config.console});
this.x_console.setPrefix({prefix:this.x_config.class,color:"yellow"});this.x_flags={init_ok:!1,dsl:a,watchdog:{start:new Date,end:new Date}};this.x_commands={};this.x_time_stats={times:{},tables:{}};this.x_state={};this.x_memory_cache={findCommand:{},findValidCommand:{},isExactParentID:{},hasBrotherBefore:{},hasBrotherNext:{}};this.x_match=require("minimatch")}init(){var a=this;return k(function*(){if(a.x_flags.init_ok)a.x_console.out({message:"you may only call method init() once!"});else{var b=
require("dsl_parser"),c=require("path"),d=require("fs").promises;a.x_console.title({title:"DSL Interpreter ".concat(a.x_config.class,"\ninit:compiling file:\n").concat(a.x_flags.dsl),color:"cyan",config:{align:"left"}});a.dsl_parser=new b({file:a.x_flags.dsl,config:{cancelled:!1,debug:a.x_config.debug}});try{yield a.dsl_parser.process()}catch(f){a.x_console.out({message:"error: file ".concat(a.x_flags.dsl," does't exist!"),data:f});return}var e=c.dirname(c.resolve(a.x_flags.dsl));a.x_console.outT({message:"time passed since start .. ".concat(a.secsPassed_()),
color:"cyan"});if(a.x_config.dsl_git){a.x_console.outT({message:"creating git compatible DSL",color:"green"});b=yield a.dsl_parser.createGitVersion();if("boolean"===typeof a.x_config.dsl_git){var g=e;a.debug("dsl_git dir",g);e=c.join(g,"vue_git.dsl");yield d.writeFile(e,b,"utf-8");a.debug("dsl_git file saved as: ".concat(e))}else"function"===typeof a.x_config.dsl_git&&(a.debug("calling dsl_git custom method ".concat(a.x_config.dsl_git.name)),yield a.x_config.dsl_git(b));a.x_console.outT({message:"ready github compatible DSL",
color:"green"})}a.x_console.outT({message:"configuring cache ..",color:"cyan"});a.cache=require("node-persist");c=c.join(g,".concepto",".dsl_cache");yield a.cache.init({dir:c,expiredInterval:108E5});a.x_flags.init_ok=!0;try{yield a.onInit()}catch(f){a.x_console.out({message:"onInit() ".concat(f),color:"red"})}}})()}reply_template(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return h(h({},{init:"",open:"",close:"",hasChildren:!0,type:"simple",valid:!0,_meta:{_set:{},cache:!0}}),
a)}onInit(){return k(function*(){console.log("hello from concepto.js")})()}onAfterProcess(a){return k(function*(){return a})()}onDefineTitle(a){var b=this;return k(function*(){var c=a.text;Object.keys(a.attributes).map(function(b){if("title"==b||"titulo"==b)return c=a.attributes[b],!1}.bind(b));return c})()}onDefineFilename(a){return k(function*(){return a.text})()}onDefineNodeName(a){return k(function*(){return a.text.replace(" ","_")})()}onCompleteCodeTemplate(a){return k(function*(){return a})()}onPrepare(){return k(function*(){})()}onErrors(a){return k(function*(){})()}onCreateFiles(a){return k(function*(){})()}onEnd(){return k(function*(){})()}addCommands(a){var b=
this;return k(function*(){if(!b.x_flags.init_ok)throw Error("error! the first called method must be init()!");if(a&&"function"===typeof a){var c=yield a(b);if("object"===typeof c)b.x_commands=h(h({},b.x_commands),c);else throw Error("error! addCommands() argument doesn't reply with an Object");}else a&&"object"===typeof a&&(b.x_commands=h(h({},b.x_commands),a));var d="";b.x_commands.meta&&b.x_commands.meta.version&&(d=b.x_commands.meta.version);c={};for(var e in b.x_commands)c[e]=yield b.dsl_parser.hash(b.x_commands[e].func.toString());
e=yield b.dsl_parser.hash(c);var g=yield b.cache.getItem("commands_hash"),f=yield b.cache.getItem("commands_hashes");""!=d&&(d="v"+d+", ");var q=[];b.x_console.outT({message:"x_commands ".concat(d,"hash: ").concat(e),color:"white"});if(g!=e){if("object"===typeof f){for(var m in c)m in f&&f[m]!=c[m]&&q.push(m);0<q.length&&b.x_console.outT({message:"x_commands has changed hash! cleaning cache of x_commands: ".concat(q.join(",")),color:"yellow"});if((m=yield b.cache.getItem("meta_cache"))&&"object"===
typeof m&&0<Object.keys(m).length)for(var v in m)0<b.array_intersect(m[v].x_ids.split(","),q).length&&(b.x_console.outT({message:"removing ".concat(v," file info from cache .."),color:"dim"}),yield b.cache.removeItem(m[v].cachekey))}else b.x_console.outT({message:"x_commands has changed hash! cleaning all previous cache",color:"yellow"}),yield b.cache.clear();yield b.cache.setItem("commands_hash",e);yield b.cache.setItem("commands_hashes",c)}})()}findCommand(){var a=arguments,b=this;return k(function*(){var {node:c=
b.throwIfMissing("node"),justone:d=!0,show_debug:e=!0}=0<a.length&&void 0!==a[0]?a[0]:{};if(!b.x_flags.init_ok)throw Error("error! the first called method must be init()!");var g=h(h({},b.reply_template()),{id:"not_found",hint:"failover command"}),f=[];if("undefined"===typeof c.icons)return e&&b.debug("error: findCommand was given a blank node!"),g;var q=c.id+c.date_modified.toString(),m=yield b.cache.getItem(q);if(m&&(Array.isArray(m)&&0<m.length||m.data))return e&&b.debug("using memory_cache for findCommand for node ID ".concat(c.id)),
m;e&&b.debug("findCommand for node ID ".concat(c.id));m=A("x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent","");h({},m);m=h({},m);var v=A("x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent",!0),p;for(p in b.x_commands){var l=h({},v),n=h(h({},m),b.x_commands[p]);delete n.func;if(""!=n.x_icons){b.debug_time({id:"".concat(p,
" x_icons")});for(var k of n.x_icons.split(",")){l.x_icons=c.icons.includes(k)?!0:!1;if(!l.x_icons)break;yield w()}b.debug_timeEnd({id:"".concat(p," x_icons")})}""!=n.x_not_icons&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(p," x_not_icons")}),0<c.icons.length&&""!=n.x_not_icons&&["*"].includes(n.x_not_icons)?l.x_not_icons=!1:""!=n.x_not_icons&&(l.x_not_icons=
0<b.array_intersect(n.x_not_icons.split(","),c.icons).length?!1:!0),b.debug_timeEnd({id:"".concat(p," x_not_icons")}));if(""!=n.x_not_empty&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(p," x_not_empty")});var r=n.x_not_empty.replace(/\+/g,"/").replace(/,/g,"+").replace(/\//g,",").split(","),u;for(u of r){if(-1!=u.indexOf(".")){if(r=B(c,u),"string"===typeof r&&
""==r||"boolean"===typeof r&&0==r){l.x_not_empty=!1;break}}else-1!=u.indexOf("[")?function(){var a=u.split("[")[0],d=b.dsl_parser.findVariables({text:u,symbol:"[",symbol_closing:"]"}).split("+"),e=[];if("attributes"!=a&&c[a])for(var m of c[a])Object.keys(m).filter(function(a){e.push(a)});else"attributes"==a&&Object.keys(c.attributes).filter(function(a){e.push(a)});b.array_intersect(e,d).length!=d.length&&(l.x_not_empty=!1)}():u in c&&"string"===typeof c[u]&&""==c[u]?l.x_not_empty=!1:u in c&&"boolean"===
typeof c[u]&&0==c[u]?l.x_not_empty=!1:"undefined"===typeof c[u]&&(l.x_not_empty=!1);yield w()}b.debug_timeEnd({id:"".concat(p," x_not_empty")})}if(""!=n.x_not_text_contains&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(p," x_not_text_contains")});for(var x of n.x_not_text_contains.split(",")){if(-1!=c.text.indexOf(x)){l.x_not_text_contains=!1;break}yield w()}b.debug_timeEnd({id:"".concat(p,
" x_not_text_contains")})}if(""!=n.x_empty&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(p," x_empty")});for(var y of n.x_empty.split(",")){r=B(c,y);if("string"===typeof r&&""!=r){l.x_empty=!1;break}else if("object"===typeof r&&0<r.length){l.x_empty=!1;break}else if("undefined"===typeof r){l.x_empty=!1;break}yield w()}b.debug_timeEnd({id:"".concat(p," x_empty")})}t(l,
"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&""!=n.x_text_exact&&(b.debug_time({id:"".concat(p," x_text_exact")}),l.x_text_exact=n.x_text_exact==c.text?!0:!1,b.debug_timeEnd({id:"".concat(p," x_text_exact")}));if(t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&""!=n.x_text_contains){b.debug_time({id:"".concat(p,
" x_text_contains")});if(-1!=n.x_text_contains.indexOf("|")){r=!1;for(var z of n.x_text_contains.split("|"))if(-1!=c.text.indexOf(z)){r=!0;break}l.x_text_contains=r}else if(-1!=n.x_text_contains.indexOf(","))for(var C of n.x_text_contains.split(",")){if(-1==c.text.indexOf(C)||""==C&&-1==c.text.indexOf(",")){l.x_text_contains=!1;break}}else-1==c.text.toLowerCase().indexOf(n.x_text_contains.toLowerCase())&&(l.x_text_contains=!1);b.debug_timeEnd({id:"".concat(p," x_text_contains")})}""!=n.x_level&&t(l,
"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(p," x_level")}),l.x_level=E(c.level,n.x_level),b.debug_timeEnd({id:"".concat(p," x_level")}));""!=n.x_or_hasparent&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(p," x_or_hasparent")}),
l.x_or_hasparent=yield b.hasParentID(c.id,n.x_or_hasparent),b.debug_timeEnd({id:"".concat(p," x_or_hasparent")}));""!=n.x_all_hasparent&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(p," x_all_hasparent")}),l.x_all_hasparent=yield b.hasParentID(c.id,n.x_all_hasparent,!0),b.debug_timeEnd({id:"".concat(p," x_all_hasparent")}));if(""!=n.x_or_isparent&&t(l,
"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(p," x_or_isparent")});r=!1;for(var F of n.x_or_isparent.split(",")){r=yield b.isExactParentID(c.id,F);if(1==r)break;yield w()}l.x_or_isparent=r;b.debug_timeEnd({id:"".concat(p," x_or_isparent")})}"string"===typeof n.x_text_pattern&&""!=n.x_text_pattern&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&
(b.debug_time({id:"".concat(p," x_text_pattern")}),l.x_text_pattern=b.x_match(c.text.trim(),n.x_text_pattern),b.debug_timeEnd({id:"".concat(p," x_text_pattern")}));if(1==Array.isArray(n.x_text_pattern)&&0<n.x_text_pattern.length&&t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(p," x_text_pattern[]")});r=!1;var G=c.text.trim(),D;for(D of n.x_text_pattern)if(r=
b.x_match(G,D),1==r)break;l.x_text_pattern=r;b.debug_timeEnd({id:"".concat(p," x_text_pattern[]")})}if(t(l,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent"))if(g=Object.entries(n).reduce((a,b)=>a+(""!=b[1]),0),g=h(h(h({},{x_priority:-1}),b.x_commands[p]),{x_id:p,priority:g}),d)break;else f.push(g);yield w()}e&&b.debug_time({id:"sorting by priority"});f=f.sort(function(a,b){return-1!=a.x_priority&&
-1!=b.x_priority?b.x_priority-a.x_priority:b.priority-a.priority});e&&b.debug_timeEnd({id:"sorting by priority"});d||(g=f);if(Array.isArray(g)&&0<g.length||g.data)yield b.cache.setItem(q,g);return g})()}findValidCommand(){var a=arguments,b=this;return k(function*(){var {node:c=b.throwIfMissing("node"),object:d=!1,x_command_shared_state:e={},show_debug:g=!0}=0<a.length&&void 0!==a[0]?a[0]:{};if(!b.x_flags.init_ok)throw Error("error! the first called method must be init()!");if(c.id in b.x_memory_cache.findValidCommand)return b.x_memory_cache.findValidCommand[c.id];
g&&b.debug({message:"findValidCommand called for node ".concat(c.id,", level:").concat(c.level,", text:").concat(c.text),color:"yellow"});var f={},q=yield b.findCommand({node:c,justone:!1,show_debug:g});if(0==q.length)b.debug({message:"findValidCommand: no command found.",color:"red"}),f.error=!0,f.catch="no command found";else if(1==q.length){f=h({},q[0]);try{var m=yield b.x_commands[f.x_id].func(c,e);f.exec=m;f._f4e=q[0].x_id;g&&b.debug({message:"findValidCommand: 1/1 applying command ".concat(q[0].x_id,
" ... VALID MATCH FOUND! (nodeid:").concat(c.id,")"),color:"green"})}catch(l){g&&b.debug({message:"findValidCommand: 1/1 applying command ".concat(q[0].x_id," ... ERROR! (nodeid:").concat(c.id,")"),color:"red"}),f.error=!0,f.valid=!1,f.catch=l}}else{g&&b.debug({message:"findValidCommand: ".concat(q.length," commands found: (nodeid:").concat(c.id,")"),color:"green"});for(var v in q){m=q[v];try{var p=yield b.x_commands[m.x_id].func(c,e);if(p&&p.valid&&1==p.valid){g&&b.debug({message:"findValidCommand: ".concat(parseInt(v)+
1,"/").concat(q.length," testing command ").concat(m.x_id," ... VALID MATCH FOUND! (nodeid:").concat(c.id,")"),color:"green"});g&&b.debug({message:"---------------------",time:!1});d?f=p:(f=m,f.exec=p,f._f4e=m.x_id);break}}catch(l){g&&b.debug({message:"findValidCommand: error executing command ".concat(m," (nodeid:").concat(c.id,")"),data:l,color:"red"}),f.error=!0,f.valid=!1,f.catch=l}yield w()}}0==Object.keys(f).length&&(f=!1);return b.x_memory_cache.findValidCommand[c.id]=f})()}process(){var a=
this;return k(function*(){if(!a.x_flags.init_ok)throw Error("error! the first called method must be init()!");a.debug_time({id:"process/writer"});var b={nodes:[]};a.x_console.outT({prefix:"process,yellow",message:"processing nodes ..",color:"cyan"});var c=yield a.dsl_parser.getNodes({level:2,nodes_raw:!0,hash_content:!0});a.debug("calling onPrepare");a.debug_time({id:"onPrepare"});yield a.onPrepare();a.debug_timeEnd({id:"onPrepare"});a.x_config.debug||(a.progress_multi={},a.multibar=a.x_console.progress({format:"{text} {bar} | {screen}",
config:{barsize:20,etaBuffer:500,fps:20},formatData:a=>{"undefined"===typeof a.error&&(a.error=!1);a.error&&1==a.error?(a.bar=a.funcs.colors.red(a.bar),a.text=a.funcs.colors.red("processing error")):a.bar=20>=a.percentage?a.funcs.colors.magenta(a.bar):60>=a.percentage?a.funcs.colors.yellow(a.bar):a.funcs.colors.green(a.bar);a.screen&&(a.screen=a.funcs.colors.cyan(a.screen));if(a.total_&&"x"==a.total_)if(100<=a.percentage){var b=a.funcs.colors.dim(" - {duration}");a._format="{text}"+b;a.text=a.funcs.colors.green("processing complete! ")+
a.funcs.symbols.success}else a._format="{text} {bar} | {screen} ({eta} remaining)",a.text=a.funcs.colors.dim("overall progress");else a.sub&&""!=a.sub&&(a.sub=a.funcs.colors.dim(a.sub),a.percentage=a.funcs.colors.dim(a.percentage+" %"),a._format="{text} {bar} | {screen} -> {sub} {percentage}"),100<=a.percentage?(b=a.funcs.colors.dim(" - {duration}"),a._format="{text} | {screen}"+b,a.text="processing done! "+a.funcs.symbols.success):a.text=a.funcs.colors.dim("processing");return a}}),a.progress_multi._total_=
a.multibar.create(c.length-1,{total_:"x",screen:"initializing.."}));var d=0,e={},g=yield a.cache.getItem("meta_cache");g&&(e=g);for(var f of c)a.x_config.debug||(a.progress_last&&a.progress_last.raw().stop(),a.progress_multi[f.text]=a.multibar.create(f.nodes_raw.length-1,{total_:"",screen:"initializing.."}),a.progress_multi._total_.update(d,{total_:"x",screen:f.text}),a.progress_last=a.progress_multi[f.text],a.progress_last_screen=f.text),(c=yield a.cache.getItem(f.hash_content))?(g=yield a.cache.getItem(f.hash_content+
"_x_state"),a.x_state=h(h({},a.x_state),g),c.error&&1==c.error&&(yield a.cache.removeItem(f.hash_content),c=yield a.process_main(f,{}),c.error&&1==c.error||(e[c.file]={cachekey:f.hash_content,x_ids:c.x_ids},yield a.cache.setItem(f.hash_content,c),yield a.cache.setItem(f.hash_content+"_x_state",a.x_state)))):(c=yield a.process_main(f,{}),c.error&&1==c.error||(e[c.file]={cachekey:f.hash_content,x_ids:c.x_ids},yield a.cache.setItem(f.hash_content,c),yield a.cache.setItem(f.hash_content+"_x_state",a.x_state))),
a.x_config.debug||(a.progress_multi[f.text].total(f.nodes_raw.length-1),a.progress_multi[f.text].update(f.nodes_raw.length-1,{screen:f.text,sub:"",total_:""})),b.nodes.push(c),yield w(),d+=1;a.x_config.debug||(a.progress_multi._total_.raw().stop(),a.multibar.stop());a.debug_timeEnd({id:"process/writer"});var q=!1;b.nodes.map(function(a){if(1==a.error)return q=!0,!1});q?a.x_console.title({title:"Interpreter ".concat(a.x_config.class.toUpperCase()," ENDED with ERRORS.\nPlease check your console history.\nCompilation took: ").concat(a.secsPassed_()),
color:"red"}):(yield a.onCreateFiles(b.nodes),a.x_console.title({title:"Interpreter ".concat(a.x_config.class.toUpperCase()," ENDED. Full Compilation took: ").concat(a.secsPassed_()),color:"green"}),a.debug_table("Amount of Time Per Command"));yield a.onEnd();yield a.cache.setItem("last_compile_date",new Date);yield a.cache.setItem("meta_cache",e);return b})()}sub_process(a,b,c){var d=this;return k(function*(){var e=h({},a);if(1==e.hasChildren&&1==e.valid){var g=yield b.getNodes(),f={},q=0;b.state&&
(f=h({},b.state));f=h(h({},f),c);d.x_config.debug||d.progress_last.total(g.length-1);for(var m of g){q+=1;g=yield d.dsl_parser.getNode({id:m.id,nodes_raw:!0,recurse:!1});var k=yield d.findValidCommand({node:g,object:!1,x_command_shared_state:f});d.x_config.debug||d.progress_last.update(q,{screen:d.progress_last_screen,sub:k.x_id,total_:""});k.state&&(f=h(h({},f),k.state));if(k&&k.exec&&1==k.exec.valid)k.exec.state&&(f=h(h({},f),k.exec.state)),e.init+=k.exec.init,e.code+=k.exec.open,e.x_ids||(e.x_ids=
[]),e.x_ids.push(k.x_id),e=yield d.sub_process(e,m,f),e.code+=k.exec.close;else if(1==k.error){d.x_config.debug||(d.progress_last.total(q),d.progress_last.update(q,{screen:"ERROR",error:!0}));d.x_console.outT({message:"error: Executing func x_command:".concat(k.x_id," for node: id:").concat(g.id,", level ").concat(g.level,", text: ").concat(g.text,"."),data:{id:g.id,level:g.level,text:g.text,data:k.catch,x_command_state:f}});yield d.onErrors(["Error executing func for x_command:".concat(k.x_id," for node id ").concat(g.id,
", text: ").concat(g.text," ")]);e.valid=!1;e.hasChildren=!1;e.error=!0;break}yield w()}}return e})()}process_main(a,b){var c=this;return k(function*(){var d={state:b,id:a.id,name:yield c.onDefineNodeName(a),file:yield c.onDefineFilename(a),init:"",title:yield c.onDefineTitle(a),attributes:a.attributes,code:"",open:"",close:"",x_ids:[],subnodes:a.nodes_raw.length};c.x_config.debug&&c.x_console.outT({prefix:"process,yellow",message:"processing node ".concat(a.text," .."),color:"yellow"});var e=h({},
b),g=yield c.findValidCommand({node:a,object:!1,x_command_shared_state:e});g&&g.exec&&1==g.exec.valid?(g.exec.state&&(e=h(h({},e),g.exec.state)),d=h(h({},d),g.exec),d.error=!1,d.init+=d.init,d.code+=d.open,d.state=e,d.x_ids||(d.x_ids=[]),d.x_ids.push(g.x_id),"function"===typeof a.getNodes&&(d=yield c.sub_process(d,a,e)),d.code+=d.close,d.x_ids=d.x_ids.join(",")):(1==g.error?(c.x_console.outT({message:"error: Executing func x_command:".concat(g.x_id," for node: id:").concat(a.id,", level ").concat(a.level,
", text: ").concat(a.text,"."),data:{id:a.id,level:a.level,text:a.text,catch:g.catch,x_command_state:g.state}}),yield c.onErrors(["Error executing func for x_command:".concat(g.x_id," for node id ").concat(a.id,", text: ").concat(a.text," ")])):(c.x_console.outT({message:"error: FATAL, no method found for node processing.",data:{id:a.id,level:a.level,text:a.text}}),yield c.onErrors(["No method found for given node id ".concat(a.id,", text: ").concat(a.text," ")])),d.valid=!1,d.hasChildren=!1,d.error=
!0);d=yield c.onAfterProcess(d);return d=yield c.onCompleteCodeTemplate(d)})()}secsPassed_(){var a=(new Date).getTime()-this.x_flags.watchdog.start.getTime();return require("humanize-duration")(a,{maxDecimalPoints:0})}throwIfMissing(a){throw Error("Missing "+a+" parameter!");}array_intersect(a,b){return a.filter(a=>b.includes(a))}array_substract(a,b){return a.filter(a=>!b.includes(a))}array_difference(a,b){return a.filter(a=>!b.includes(a)).concat(b.filter(b=>!a.includes(b)))}array_union(a,b){return[...a,
...b]}debug(a,b){var c=1==arguments.length&&"object"===typeof arguments[0]?arguments[0]:{message:a,data:b};this.x_config.debug&&c.time?this.x_console.outT(h(h({},{prefix:"debug,dim",color:"dim"}),c)):this.x_config.debug&&this.x_console.out(h(h({},{prefix:"debug,dim",color:"dim"}),c))}_appFolders(a){var b=arguments,c=this;return k(function*(){var d=1<b.length&&void 0!==b[1]?b[1]:c.x_state.central_config.apptitle,e=2<b.length?b[2]:void 0,g=require("fs").promises;c.debug("_appFolders");var f=require("path"),
h=f.dirname(f.resolve(c.x_flags.dsl))+f.sep;e&&(h=e);e={base:h,src:h+(d?d:c.x_state.central_config.apptitle)+f.sep};e.app=f.normalize(e.src);e.compile_folder=d;for(var k in a){e[k]=f.join(e.app,a[k]);try{yield g.mkdir(e[k],{recursive:!0})}catch(v){}}return e})()}debug_time(){if(0<arguments.length){var a=h({},arguments[0]);"undefined"!==typeof a.id&&-1!=a.id.indexOf("def_")?(a=a.id.split(" ")[0],"undefined"===typeof this.x_time_stats.times[a]&&-1!=a.indexOf("def_")?(this.x_time_stats.times[a]=new Date,
this.x_time_stats.tables[a]={command:a,calls:0,average_call:0,total_ms:0}):1==this.x_config.debug&&this.x_console.time(h({},arguments[0]))):1==this.x_config.debug&&this.x_console.time(h({},arguments[0]))}}debug_timeEnd(){if(0<arguments.length){var a=h({},arguments[0]),b="";"undefined"!==typeof a.id&&(b=a.id.split(" ")[0]);"undefined"!==typeof a.id&&-1!=b.indexOf("def_")&&b in this.x_time_stats.times?"undefined"!==typeof this.x_time_stats.tables[b]&&(a=(new Date).getTime()-this.x_time_stats.times[b].getTime(),
this.x_time_stats.tables[b].calls+=1,this.x_time_stats.tables[b].total_ms=a,this.x_time_stats.tables[b].average_call=Math.round(this.x_time_stats.tables[b].total_ms/this.x_time_stats.tables[b].calls)):1==this.x_config.debug&&this.x_console.timeEnd(h(h({},{color:"dim",prefix:"debug,dim"}),arguments[0]))}}debug_table(a){var b=[];try{Object.keys(this.x_time_stats.tables).map(function(a){b.push(this.x_time_stats.tables[a])}.bind(this)),this.x_console.table({title:a?a:"Times per Command",data:b,color:"cyan"})}catch(c){this.x_console.outT({message:"used cache for finding every command",
color:"cyan"})}}hasBrotherID(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),d=1<a.length&&void 0!==a[1]?a[1]:b.throwIfMissing("x_id");if(c+d in b.x_memory_cache.hasBrotherID)return b.x_memory_cache.hasBrotherID[c+d];var e=yield b.dsl_parser.getBrotherNodesIDs({id:c,before:!0,after:!0}).split(","),g=[],f;for(f of e)if(e=yield b.dsl_parser.getNode({id:f,recurse:!1}),e=yield findValidCommand({node:e,show_debug:!1,object:!0}),g.push(e.x_id),1==
g.includes(d))return!0;return b.x_memory_cache.hasBrotherID[c+d]=!1})()}hasBrotherBefore(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id");if(!(c in b.x_memory_cache.hasBrotherBefore)){var d=yield b.dsl_parser.getBrotherNodesIDs({id:c,before:!0,after:!1}).split(",");b.x_memory_cache.hasBrotherBefore[c]=d.includes(c)}return b.x_memory_cache.hasBrotherBefore[c]})()}hasBrotherNext(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&
void 0!==a[0]?a[0]:b.throwIfMissing("id");if(!(c in b.x_memory_cache.hasBrotherNext)){var d=yield b.dsl_parser.getBrotherNodesIDs({id:c,before:!1,after:!0}).split(",");b.x_memory_cache.hasBrotherNext[c]=d.includes(c)}return b.x_memory_cache.hasBrotherNext[c]})()}isExactParentID(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),d=1<a.length&&void 0!==a[1]?a[1]:b.throwIfMissing("x_id");if(c+d in b.x_memory_cache.isExactParentID)return b.x_memory_cache.isExactParentID[c+
d];var e=yield b.dsl_parser.getParentNode({id:c});return(e=yield b.findValidCommand({node:e,show_debug:!1,object:!0}))&&e.x_id==d?b.x_memory_cache.isExactParentID[c+d]=!0:b.x_memory_cache.isExactParentID[c+d]=!1})()}hasParentID(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),d=1<a.length&&void 0!==a[1]?a[1]:b.throwIfMissing("x_id"),e=2<a.length&&void 0!==a[2]?a[2]:!1;d=d.split(",");var g=yield b.dsl_parser.getParentNodesIDs({id:c,array:!0});
c=[];for(var f of g)if(g=yield b.dsl_parser.getNode({id:f,recurse:!1}),g=yield b.findValidCommand({node:g,show_debug:!1,object:!0}),0==e&&d.includes(g.x_id)||0!=e&&1==e&&(c.push(g.x_id),b.array_intersect(c,d).length==d.length))return!0;return b.array_intersect(c,d).length==d.length?!0:!1})()}getParentIDs(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),d=1<a.length&&void 0!==a[1]?a[1]:!1,e=yield b.dsl_parser.getParentNodesIDs({id:c,array:!0});
c=[];for(var g of e)e=yield b.dsl_parser.getNode({parent_id:g,recurse:!1}),(e=yield b.findValidCommand({node:e,show_debug:!1}))&&d?c.push({id:g,x_id:e.x_id}):c.push(e.x_id);return d&&1==d?c:c.join(",")})()}getParentIDs2Array(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id");return yield b.getParentIDs(c,!0)})()}getParentIDs2ArrayWXID(){var a=arguments,b=this;return k(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id");return(yield b.getParentIDs(c,
!0)).map(a=>{a.id})})()}tagParams(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:!1,c=this.struct2params(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{});a=""!=c?"<".concat(a," ").concat(c):"<".concat(a);1==b&&(a+="/");return a+">"}struct2params(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.throwIfMissing("id"),b=[],c,d;for([c,d]of Object.entries(a))"object"!==typeof d&&"function"!==typeof d&&
"undefined"!==typeof d&&b.push("".concat(c,"='").concat(d,"'"));return b.join(" ")}cleanIDs4node(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.throwIfMissing("node");delete a.id;return a}}return z})
