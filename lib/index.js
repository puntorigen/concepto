'use strict';(function(x,h){"object"===typeof exports&&"undefined"!==typeof module?module.exports=h():"function"===typeof define&&define.amd?define(h):(x="undefined"!==typeof globalThis?globalThis:x||self,x.concepto=h())})(this,function(){function x(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable}));c.push.apply(c,d)}return c}function h(a){for(var b=1;b<arguments.length;b++){var c=
null!=arguments[b]?arguments[b]:{};b%2?x(Object(c),!0).forEach(function(b){var d=c[b];b in a?Object.defineProperty(a,b,{value:d,enumerable:!0,configurable:!0,writable:!0}):a[b]=d}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(c)):x(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}return a}function y(a,b,c,d,e,f,g){try{var q=a[f](g),h=q.value}catch(t){c(t);return}q.done?b(h):Promise.resolve(h).then(d,e)}
function l(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){y(q,d,e,f,g,"next",a)}function g(a){y(q,d,e,f,g,"throw",a)}var q=a.apply(b,c);f(void 0)})}}function A(a,b){var c=a;if("string"===typeof c){c={};a=a.split(",");for(var d in a)c[a[d]]=b}else for(var e in c)c[e]=b;return c}function u(a,b){var c=!0,d;for(d of b.split(","))if(!0!==a[d]){c=!1;break}return c}function E(a,b){var c=!0;if(b.toString()!==a.toString())if("number"===typeof b)a==b?c=!0:a!=b&&(c=
!1);else if("string"===typeof b)if(-1==b.indexOf(",")&&"<"==b.charAt(0))a>=parseInt(b.replace("<",""))&&(c=!1);else if(-1==b.indexOf(",")&&">"==b.charAt(0))a<=parseInt(b.replace(">",""))&&(c=!1);else if(-1==b.indexOf(",")&&b!=a.toString())c=!1;else{var d=b.split(",");if(-1==b.indexOf("<")&&-1==b.indexOf(">")&&d.includes(a))c=!0;else if(-1!=b.indexOf("<")||-1!=b.indexOf(">"))for(var e of d)if(">"==e.charAt(0)){if(a<=parseInt(e.replace(">",""))){c=!1;break}}else if("<"==e.charAt(0)&&a>=parseInt(e.replace("<",
""))){c=!1;break}}else c=!1;return c}function B(a,b){return b.split(".").reduce((a,b)=>a[b],a)}function w(){return new Promise(a=>{setImmediate(()=>a())})}class z{constructor(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(2!=arguments.length||"object"===typeof arguments[0])throw Error("fatal error! missing file parameter for parser!");var c=require("open_console");this.x_config=h(h({},{class:"concepto",console:!0,debug:!1,cache:!0,dsl_git:!0,prefix:""}),b);this.x_console=new c({silent:!this.x_config.console});
this.x_console.setPrefix({prefix:this.x_config.class,color:"yellow"});this.x_flags={init_ok:!1,dsl:a,watchdog:{start:new Date,end:new Date}};this.x_commands={};this.x_time_stats={times:{},tables:{}};this.x_state={};this.x_memory_cache={findCommand:{},findValidCommand:{},isExactParentID:{},hasBrotherBefore:{},hasBrotherNext:{}};this.x_match=require("minimatch")}init(){var a=this;return l(function*(){if(a.x_flags.init_ok)a.x_console.out({message:"you may only call method init() once!"});else{var b=
require("dsl_parser"),c=require("path"),d=require("fs").promises;a.x_console.title({title:"DSL Interpreter ".concat(a.x_config.class,"\ninit:compiling file:\n").concat(a.x_flags.dsl),color:"cyan",config:{align:"left"}});a.dsl_parser=new b({file:a.x_flags.dsl,config:{cancelled:!1,debug:a.x_config.debug}});try{yield a.dsl_parser.process()}catch(g){a.x_console.out({message:"error: file ".concat(a.x_flags.dsl," does't exist!"),data:g});return}var e=c.dirname(c.resolve(a.x_flags.dsl));a.x_console.outT({message:"time passed since start .. ".concat(a.secsPassed_()),
color:"cyan"});if(a.x_config.dsl_git){a.x_console.outT({message:"creating git compatible DSL",color:"green"});b=yield a.dsl_parser.createGitVersion();if("boolean"===typeof a.x_config.dsl_git){var f=e;a.debug("dsl_git dir",f);e=c.join(f,"vue_git.dsl");yield d.writeFile(e,b,"utf-8");a.debug("dsl_git file saved as: ".concat(e))}else"function"===typeof a.x_config.dsl_git&&(a.debug("calling dsl_git custom method ".concat(a.x_config.dsl_git.name)),yield a.x_config.dsl_git(b));a.x_console.outT({message:"ready github compatible DSL",
color:"green"})}a.x_console.outT({message:"configuring cache ..",color:"cyan"});a.cache=require("node-persist");c=c.join(f,".concepto",".dsl_cache");yield a.cache.init({dir:c,expiredInterval:108E5});a.x_flags.init_ok=!0;try{yield a.onInit()}catch(g){a.x_console.out({message:"onInit() ".concat(g),color:"red"})}}})()}reply_template(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return h(h({},{init:"",open:"",close:"",hasChildren:!0,type:"simple",valid:!0,_meta:{_set:{},cache:!0}}),
a)}onInit(){return l(function*(){console.log("hello from concepto.js")})()}onAfterProcess(a){return l(function*(){return a})()}onDefineTitle(a){var b=this;return l(function*(){var c=a.text;Object.keys(a.attributes).map(function(b){if("title"==b||"titulo"==b)return c=a.attributes[b],!1}.bind(b));return c})()}onDefineFilename(a){return l(function*(){return a.text})()}onDefineNodeName(a){return l(function*(){return a.text.replace(" ","_")})()}onCompleteCodeTemplate(a){return l(function*(){return a})()}onPrepare(){return l(function*(){})()}onErrors(a){return l(function*(){})()}onCreateFiles(a){return l(function*(){})()}onEnd(){return l(function*(){})()}addCommands(a){var b=
this;return l(function*(){if(!b.x_flags.init_ok)throw Error("error! the first called method must be init()!");if(a&&"function"===typeof a){var c=yield a(b);if("object"===typeof c)b.x_commands=h(h({},b.x_commands),c);else throw Error("error! addCommands() argument doesn't reply with an Object");}else a&&"object"===typeof a&&(b.x_commands=h(h({},b.x_commands),a));c="";b.x_commands.meta&&b.x_commands.meta.version&&(c=b.x_commands.meta.version);var d=c+JSON.stringify(b.x_commands,function(a,b){return"function"===
typeof b?b.toString():b},4);d=yield b.dsl_parser.hash(d);var e=yield b.cache.getItem("commands_hash");""!=c&&(c="v"+c+", ");b.x_console.outT({message:"x_commands ".concat(c,"hash: ").concat(d),color:"white"});e!=d&&(b.x_console.outT({message:"cleaning cache! x_commands has changed hash!",color:"yellow"}),yield b.cache.clear(),yield b.cache.setItem("commands_hash",d))})()}findCommand(){var a=arguments,b=this;return l(function*(){var {node:c=b.throwIfMissing("node"),justone:d=!0,show_debug:e=!0}=0<
a.length&&void 0!==a[0]?a[0]:{};if(!b.x_flags.init_ok)throw Error("error! the first called method must be init()!");var f=h(h({},b.reply_template()),{id:"not_found",hint:"failover command"}),g=[];if("undefined"===typeof c.icons)return e&&b.debug("error: findCommand was given a blank node!"),f;var q=c.id+c.date_modified.toString(),r=yield b.cache.getItem(q);if(r&&(Array.isArray(r)&&0<r.length||r.data))return e&&b.debug("using memory_cache for findCommand for node ID ".concat(c.id)),r;e&&b.debug("findCommand for node ID ".concat(c.id));
r=A("x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent","");h({},r);r=h({},r);var l=A("x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent",!0),n;for(n in b.x_commands){var k=h({},l),m=h(h({},r),b.x_commands[n]);delete m.func;if(""!=m.x_icons){b.debug_time({id:"".concat(n," x_icons")});for(var x of m.x_icons.split(",")){k.x_icons=
c.icons.includes(x)?!0:!1;if(!k.x_icons)break;yield w()}b.debug_timeEnd({id:"".concat(n," x_icons")})}""!=m.x_not_icons&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(n," x_not_icons")}),0<c.icons.length&&""!=m.x_not_icons&&["*"].includes(m.x_not_icons)?k.x_not_icons=!1:""!=m.x_not_icons&&(k.x_not_icons=0<b.array_intersect(m.x_not_icons.split(","),c.icons).length?
!1:!0),b.debug_timeEnd({id:"".concat(n," x_not_icons")}));if(""!=m.x_not_empty&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(n," x_not_empty")});var p=m.x_not_empty.replace(/\+/g,"/").replace(/,/g,"+").replace(/\//g,",").split(","),v;for(v of p){if(-1!=v.indexOf(".")){if(p=B(c,v),"string"===typeof p&&""==p||"boolean"===typeof p&&0==p){k.x_not_empty=!1;
break}}else-1!=v.indexOf("[")?function(){var a=v.split("[")[0],d=b.dsl_parser.findVariables({text:v,symbol:"[",symbol_closing:"]"}).split("+"),e=[];if("attributes"!=a&&c[a])for(var q of c[a])Object.keys(q).filter(function(a){e.push(a)});else"attributes"==a&&Object.keys(c.attributes).filter(function(a){e.push(a)});b.array_intersect(e,d).length!=d.length&&(k.x_not_empty=!1)}():v in c&&"string"===typeof c[v]&&""==c[v]?k.x_not_empty=!1:v in c&&"boolean"===typeof c[v]&&0==c[v]?k.x_not_empty=!1:"undefined"===
typeof c[v]&&(k.x_not_empty=!1);yield w()}b.debug_timeEnd({id:"".concat(n," x_not_empty")})}if(""!=m.x_not_text_contains&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(n," x_not_text_contains")});for(var y of m.x_not_text_contains.split(",")){if(-1!=c.text.indexOf(y)){k.x_not_text_contains=!1;break}yield w()}b.debug_timeEnd({id:"".concat(n," x_not_text_contains")})}if(""!=
m.x_empty&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(n," x_empty")});for(var z of m.x_empty.split(",")){p=B(c,z);if("string"===typeof p&&""!=p){k.x_empty=!1;break}else if("object"===typeof p&&0<p.length){k.x_empty=!1;break}else if("undefined"===typeof p){k.x_empty=!1;break}yield w()}b.debug_timeEnd({id:"".concat(n," x_empty")})}u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&
""!=m.x_text_exact&&(b.debug_time({id:"".concat(n," x_text_exact")}),k.x_text_exact=m.x_text_exact==c.text?!0:!1,b.debug_timeEnd({id:"".concat(n," x_text_exact")}));if(u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&""!=m.x_text_contains){b.debug_time({id:"".concat(n," x_text_contains")});if(-1!=m.x_text_contains.indexOf("|")){p=!1;for(var F of m.x_text_contains.split("|"))if(-1!=c.text.indexOf(F)){p=
!0;break}k.x_text_contains=p}else if(-1!=m.x_text_contains.indexOf(","))for(var C of m.x_text_contains.split(",")){if(-1==c.text.indexOf(C)||""==C&&-1==c.text.indexOf(",")){k.x_text_contains=!1;break}}else-1==c.text.toLowerCase().indexOf(m.x_text_contains.toLowerCase())&&(k.x_text_contains=!1);b.debug_timeEnd({id:"".concat(n," x_text_contains")})}""!=m.x_level&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&
(b.debug_time({id:"".concat(n," x_level")}),k.x_level=E(c.level,m.x_level),b.debug_timeEnd({id:"".concat(n," x_level")}));""!=m.x_or_hasparent&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(n," x_or_hasparent")}),k.x_or_hasparent=yield b.hasParentID(c.id,m.x_or_hasparent),b.debug_timeEnd({id:"".concat(n," x_or_hasparent")}));""!=m.x_all_hasparent&&u(k,
"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(n," x_all_hasparent")}),k.x_all_hasparent=yield b.hasParentID(c.id,m.x_all_hasparent,!0),b.debug_timeEnd({id:"".concat(n," x_all_hasparent")}));if(""!=m.x_or_isparent&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(n,
" x_or_isparent")});p=!1;for(var G of m.x_or_isparent.split(",")){p=yield b.isExactParentID(c.id,G);if(1==p)break;yield w()}k.x_or_isparent=p;b.debug_timeEnd({id:"".concat(n," x_or_isparent")})}"string"===typeof m.x_text_pattern&&""!=m.x_text_pattern&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")&&(b.debug_time({id:"".concat(n," x_text_pattern")}),k.x_text_pattern=b.x_match(c.text.trim(),
m.x_text_pattern),b.debug_timeEnd({id:"".concat(n," x_text_pattern")}));if(1==Array.isArray(m.x_text_pattern)&&0<m.x_text_pattern.length&&u(k,"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent")){b.debug_time({id:"".concat(n," x_text_pattern[]")});p=!1;var H=c.text.trim(),D;for(D of m.x_text_pattern)if(p=b.x_match(H,D),1==p)break;k.x_text_pattern=p;b.debug_timeEnd({id:"".concat(n," x_text_pattern[]")})}if(u(k,
"x_icons,x_not_icons,x_not_empty,x_not_text_contains,x_empty,x_text_exact,x_text_contains,x_text_pattern,x_level,x_or_hasparent,x_all_hasparent,x_or_isparent"))if(f=Object.entries(m).reduce((a,b)=>a+(""!=b[1]),0),f=h(h(h({},{x_priority:-1}),b.x_commands[n]),{x_id:n,priority:f}),d)break;else g.push(f);yield w()}e&&b.debug_time({id:"sorting by priority"});g=g.sort(function(a,b){return-1!=a.x_priority&&-1!=b.x_priority?b.x_priority-a.x_priority:b.priority-a.priority});e&&b.debug_timeEnd({id:"sorting by priority"});
d||(f=g);if(Array.isArray(f)&&0<f.length||f.data)yield b.cache.setItem(q,f);return f})()}findValidCommand(){var a=arguments,b=this;return l(function*(){var {node:c=b.throwIfMissing("node"),object:d=!1,x_command_shared_state:e={},show_debug:f=!0}=0<a.length&&void 0!==a[0]?a[0]:{};if(!b.x_flags.init_ok)throw Error("error! the first called method must be init()!");if(c.id in b.x_memory_cache.findValidCommand)return b.x_memory_cache.findValidCommand[c.id];f&&b.debug({message:"findValidCommand called for node ".concat(c.id,
", level:").concat(c.level,", text:").concat(c.text),color:"yellow"});var g={},q=yield b.findCommand({node:c,justone:!1,show_debug:f});if(0==q.length)b.debug({message:"findValidCommand: no command found.",color:"red"}),g.error=!0,g.catch="no command found";else if(1==q.length){g=h({},q[0]);try{var r=yield b.x_commands[g.x_id].func(c,e);g.exec=r;g._f4e=q[0].x_id;f&&b.debug({message:"findValidCommand: 1/1 applying command ".concat(q[0].x_id," ... VALID MATCH FOUND! (nodeid:").concat(c.id,")"),color:"green"})}catch(k){f&&
b.debug({message:"findValidCommand: 1/1 applying command ".concat(q[0].x_id," ... ERROR! (nodeid:").concat(c.id,")"),color:"red"}),g.error=!0,g.valid=!1,g.catch=k}}else{f&&b.debug({message:"findValidCommand: ".concat(q.length," commands found: (nodeid:").concat(c.id,")"),color:"green"});for(var l in q){r=q[l];try{var n=yield b.x_commands[r.x_id].func(c,e);if(n&&n.valid&&1==n.valid){f&&b.debug({message:"findValidCommand: ".concat(parseInt(l)+1,"/").concat(q.length," testing command ").concat(r.x_id,
" ... VALID MATCH FOUND! (nodeid:").concat(c.id,")"),color:"green"});f&&b.debug({message:"---------------------",time:!1});d?g=n:(g=r,g.exec=n,g._f4e=r.x_id);break}}catch(k){f&&b.debug({message:"findValidCommand: error executing command ".concat(r," (nodeid:").concat(c.id,")"),data:k,color:"red"}),g.error=!0,g.valid=!1,g.catch=k}yield w()}}0==Object.keys(g).length&&(g=!1);return b.x_memory_cache.findValidCommand[c.id]=g})()}process(){var a=this;return l(function*(){if(!a.x_flags.init_ok)throw Error("error! the first called method must be init()!");
a.debug_time({id:"process/writer"});var b={nodes:[]};a.x_console.outT({prefix:"process,yellow",message:"processing nodes ..",color:"cyan"});var c=yield a.dsl_parser.getNodes({level:2,nodes_raw:!0,hash_content:!0});a.debug("calling onPrepare");a.debug_time({id:"onPrepare"});yield a.onPrepare();a.debug_timeEnd({id:"onPrepare"});a.x_config.debug||(a.progress_multi={},a.multibar=a.x_console.progress({format:"{text} {bar} | {screen}",config:{barsize:20,etaBuffer:500,fps:20},formatData:a=>{"undefined"===
typeof a.error&&(a.error=!1);a.error&&1==a.error?(a.bar=a.funcs.colors.red(a.bar),a.text=a.funcs.colors.red("processing error")):a.bar=20>=a.percentage?a.funcs.colors.magenta(a.bar):60>=a.percentage?a.funcs.colors.yellow(a.bar):a.funcs.colors.green(a.bar);a.screen&&(a.screen=a.funcs.colors.cyan(a.screen));if(a.total_&&"x"==a.total_)if(100<=a.percentage){var b=a.funcs.colors.dim(" - {duration}");a._format="{text}"+b;a.text=a.funcs.colors.green("processing complete! ")+a.funcs.symbols.success}else a._format=
"{text} {bar} | {screen} ({eta} remaining)",a.text=a.funcs.colors.dim("overall progress");else a.sub&&""!=a.sub&&(a.sub=a.funcs.colors.dim(a.sub),a.percentage=a.funcs.colors.dim(a.percentage+" %"),a._format="{text} {bar} | {screen} -> {sub} {percentage}"),100<=a.percentage?(b=a.funcs.colors.dim(" - {duration}"),a._format="{text} | {screen}"+b,a.text="processing done! "+a.funcs.symbols.success):a.text=a.funcs.colors.dim("processing");return a}}),a.progress_multi._total_=a.multibar.create(c.length-
1,{total_:"x",screen:"initializing.."}));var d=0,e;for(e of c){a.x_config.debug||(a.progress_last&&a.progress_last.raw().stop(),a.progress_multi[e.text]=a.multibar.create(e.nodes_raw.length-1,{total_:"",screen:"initializing.."}),a.progress_multi._total_.update(d,{total_:"x",screen:e.text}),a.progress_last=a.progress_multi[e.text],a.progress_last_screen=e.text);if(c=yield a.cache.getItem(e.hash_content)){var f=yield a.cache.getItem(e.hash_content+"_x_state");a.x_state=h(h({},a.x_state),f);c.error&&
1==c.error&&(yield a.cache.removeItem(e.hash_content),c=yield a.process_main(e,{}),c.error&&1==c.error||(yield a.cache.setItem(e.hash_content,c),yield a.cache.setItem(e.hash_content+"_x_state",a.x_state)))}else c=yield a.process_main(e,{}),c.error&&1==c.error||(yield a.cache.setItem(e.hash_content,c),yield a.cache.setItem(e.hash_content+"_x_state",a.x_state));a.x_config.debug||(a.progress_multi[e.text].total(e.nodes_raw.length-1),a.progress_multi[e.text].update(e.nodes_raw.length-1,{screen:e.text,
sub:"",total_:""}));b.nodes.push(c);yield w();d+=1}a.x_config.debug||(a.progress_multi._total_.raw().stop(),a.multibar.stop());a.debug_timeEnd({id:"process/writer"});var g=!1;b.nodes.map(function(a){if(1==a.error)return g=!0,!1});g?a.x_console.title({title:"Interpreter ".concat(a.x_config.class.toUpperCase()," ENDED with ERRORS.\nPlease check your console history.\nCompilation took: ").concat(a.secsPassed_()),color:"red"}):(yield a.onCreateFiles(b.nodes),a.x_console.title({title:"Interpreter ".concat(a.x_config.class.toUpperCase(),
" ENDED. Full Compilation took: ").concat(a.secsPassed_()),color:"green"}),a.debug_table("Amount of Time Per Command"));yield a.onEnd();yield a.cache.setItem("last_compile_date",new Date);return b})()}sub_process(a,b,c){var d=this;return l(function*(){var e=h({},a);if(1==e.hasChildren&&1==e.valid){var f=yield b.getNodes(),g={},l=0;b.state&&(g=h({},b.state));g=h(h({},g),c);d.x_config.debug||d.progress_last.total(f.length-1);for(var r of f){l+=1;f=yield d.dsl_parser.getNode({id:r.id,nodes_raw:!0,recurse:!1});
var t=yield d.findValidCommand({node:f,object:!1,x_command_shared_state:g});d.x_config.debug||d.progress_last.update(l,{screen:d.progress_last_screen,sub:t.x_id,total_:""});t.state&&(g=h(h({},g),t.state));if(t&&t.exec&&1==t.exec.valid)t.exec.state&&(g=h(h({},g),t.exec.state)),e.init+=t.exec.init,e.code+=t.exec.open,e.x_ids||(e.x_ids=[]),e.x_ids.push(t.x_id),e=yield d.sub_process(e,r,g),e.code+=t.exec.close;else if(1==t.error){d.x_config.debug||(d.progress_last.total(l),d.progress_last.update(l,{screen:"ERROR",
error:!0}));d.x_console.outT({message:"error: Executing func x_command:".concat(t.x_id," for node: id:").concat(f.id,", level ").concat(f.level,", text: ").concat(f.text,"."),data:{id:f.id,level:f.level,text:f.text,data:t.catch,x_command_state:g}});yield d.onErrors(["Error executing func for x_command:".concat(t.x_id," for node id ").concat(f.id,", text: ").concat(f.text," ")]);e.valid=!1;e.hasChildren=!1;e.error=!0;break}yield w()}}return e})()}process_main(a,b){var c=this;return l(function*(){var d=
{state:b,id:a.id,name:yield c.onDefineNodeName(a),file:yield c.onDefineFilename(a),init:"",title:yield c.onDefineTitle(a),attributes:a.attributes,code:"",open:"",close:"",x_ids:[],subnodes:a.nodes_raw.length};c.x_config.debug&&c.x_console.outT({prefix:"process,yellow",message:"processing node ".concat(a.text," .."),color:"yellow"});var e=h({},b),f=yield c.findValidCommand({node:a,object:!1,x_command_shared_state:e});f&&f.exec&&1==f.exec.valid?(f.exec.state&&(e=h(h({},e),f.exec.state)),d=h(h({},d),
f.exec),d.error=!1,d.init+=d.init,d.code+=d.open,d.state=e,d.x_ids||(d.x_ids=[]),d.x_ids.push(f.x_id),"function"===typeof a.getNodes&&(d=yield c.sub_process(d,a,e)),d.code+=d.close,d.x_ids=d.x_ids.join(",")):(1==f.error?(c.x_console.outT({message:"error: Executing func x_command:".concat(f.x_id," for node: id:").concat(a.id,", level ").concat(a.level,", text: ").concat(a.text,"."),data:{id:a.id,level:a.level,text:a.text,catch:f.catch,x_command_state:f.state}}),yield c.onErrors(["Error executing func for x_command:".concat(f.x_id,
" for node id ").concat(a.id,", text: ").concat(a.text," ")])):(c.x_console.outT({message:"error: FATAL, no method found for node processing.",data:{id:a.id,level:a.level,text:a.text}}),yield c.onErrors(["No method found for given node id ".concat(a.id,", text: ").concat(a.text," ")])),d.valid=!1,d.hasChildren=!1,d.error=!0);d=yield c.onAfterProcess(d);return d=yield c.onCompleteCodeTemplate(d)})()}secsPassed_(){var a=(new Date).getTime()-this.x_flags.watchdog.start.getTime();return require("humanize-duration")(a,
{maxDecimalPoints:0})}throwIfMissing(a){throw Error("Missing "+a+" parameter!");}array_intersect(a,b){return a.filter(a=>b.includes(a))}array_substract(a,b){return a.filter(a=>!b.includes(a))}array_difference(a,b){return a.filter(a=>!b.includes(a)).concat(b.filter(b=>!a.includes(b)))}array_union(a,b){return[...a,...b]}debug(a,b){var c=1==arguments.length&&"object"===typeof arguments[0]?arguments[0]:{message:a,data:b};this.x_config.debug&&c.time?this.x_console.outT(h(h({},{prefix:"debug,dim",color:"dim"}),
c)):this.x_config.debug&&this.x_console.out(h(h({},{prefix:"debug,dim",color:"dim"}),c))}_appFolders(a){var b=arguments,c=this;return l(function*(){var d=1<b.length&&void 0!==b[1]?b[1]:c.x_state.central_config.apptitle,e=2<b.length?b[2]:void 0,f=require("fs").promises;c.debug("_appFolders");var g=require("path"),h=g.dirname(g.resolve(c.x_flags.dsl))+g.sep;e&&(h=e);e={base:h,src:h+(d?d:c.x_state.central_config.apptitle)+g.sep};e.app=g.normalize(e.src);e.compile_folder=d;for(var l in a){e[l]=g.join(e.app,
a[l]);try{yield f.mkdir(e[l],{recursive:!0})}catch(t){}}return e})()}debug_time(){if(0<arguments.length){var a=h({},arguments[0]);"undefined"!==typeof a.id&&-1!=a.id.indexOf("def_")?(a=a.id.split(" ")[0],"undefined"===typeof this.x_time_stats.times[a]&&-1!=a.indexOf("def_")?(this.x_time_stats.times[a]=new Date,this.x_time_stats.tables[a]={command:a,calls:0,average_call:0,total_ms:0}):1==this.x_config.debug&&this.x_console.time(h({},arguments[0]))):1==this.x_config.debug&&this.x_console.time(h({},
arguments[0]))}}debug_timeEnd(){if(0<arguments.length){var a=h({},arguments[0]),b="";"undefined"!==typeof a.id&&(b=a.id.split(" ")[0]);"undefined"!==typeof a.id&&-1!=b.indexOf("def_")&&b in this.x_time_stats.times?"undefined"!==typeof this.x_time_stats.tables[b]&&(a=(new Date).getTime()-this.x_time_stats.times[b].getTime(),this.x_time_stats.tables[b].calls+=1,this.x_time_stats.tables[b].total_ms=a,this.x_time_stats.tables[b].average_call=Math.round(this.x_time_stats.tables[b].total_ms/this.x_time_stats.tables[b].calls)):
1==this.x_config.debug&&this.x_console.timeEnd(h(h({},{color:"dim",prefix:"debug,dim"}),arguments[0]))}}debug_table(a){var b=[];try{Object.keys(this.x_time_stats.tables).map(function(a){b.push(this.x_time_stats.tables[a])}.bind(this)),this.x_console.table({title:a?a:"Times per Command",data:b,color:"cyan"})}catch(c){this.x_console.outT({message:"used cache for finding every command",color:"cyan"})}}hasBrotherID(){var a=arguments,b=this;return l(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),
d=1<a.length&&void 0!==a[1]?a[1]:b.throwIfMissing("x_id");if(c+d in b.x_memory_cache.hasBrotherID)return b.x_memory_cache.hasBrotherID[c+d];var e=yield b.dsl_parser.getBrotherNodesIDs({id:c,before:!0,after:!0}).split(","),f=[],g;for(g of e)if(e=yield b.dsl_parser.getNode({id:g,recurse:!1}),e=yield findValidCommand({node:e,show_debug:!1,object:!0}),f.push(e.x_id),1==f.includes(d))return!0;return b.x_memory_cache.hasBrotherID[c+d]=!1})()}hasBrotherBefore(){var a=arguments,b=this;return l(function*(){var c=
0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id");if(!(c in b.x_memory_cache.hasBrotherBefore)){var d=yield b.dsl_parser.getBrotherNodesIDs({id:c,before:!0,after:!1}).split(",");b.x_memory_cache.hasBrotherBefore[c]=d.includes(c)}return b.x_memory_cache.hasBrotherBefore[c]})()}hasBrotherNext(){var a=arguments,b=this;return l(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id");if(!(c in b.x_memory_cache.hasBrotherNext)){var d=yield b.dsl_parser.getBrotherNodesIDs({id:c,before:!1,
after:!0}).split(",");b.x_memory_cache.hasBrotherNext[c]=d.includes(c)}return b.x_memory_cache.hasBrotherNext[c]})()}isExactParentID(){var a=arguments,b=this;return l(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),d=1<a.length&&void 0!==a[1]?a[1]:b.throwIfMissing("x_id");if(c+d in b.x_memory_cache.isExactParentID)return b.x_memory_cache.isExactParentID[c+d];var e=yield b.dsl_parser.getParentNode({id:c});return(e=yield b.findValidCommand({node:e,show_debug:!1,object:!0}))&&
e.x_id==d?b.x_memory_cache.isExactParentID[c+d]=!0:b.x_memory_cache.isExactParentID[c+d]=!1})()}hasParentID(){var a=arguments,b=this;return l(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),d=1<a.length&&void 0!==a[1]?a[1]:b.throwIfMissing("x_id"),e=2<a.length&&void 0!==a[2]?a[2]:!1;d=d.split(",");var f=yield b.dsl_parser.getParentNodesIDs({id:c,array:!0});c=[];for(var g of f)if(f=yield b.dsl_parser.getNode({id:g,recurse:!1}),f=yield b.findValidCommand({node:f,show_debug:!1,
object:!0}),0==e&&d.includes(f.x_id)||0!=e&&1==e&&(c.push(f.x_id),b.array_intersect(c,d).length==d.length))return!0;return b.array_intersect(c,d).length==d.length?!0:!1})()}getParentIDs(){var a=arguments,b=this;return l(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id"),d=1<a.length&&void 0!==a[1]?a[1]:!1,e=yield b.dsl_parser.getParentNodesIDs({id:c,array:!0});c=[];for(var f of e)e=yield b.dsl_parser.getNode({parent_id:f,recurse:!1}),(e=yield b.findValidCommand({node:e,show_debug:!1}))&&
d?c.push({id:f,x_id:e.x_id}):c.push(e.x_id);return d&&1==d?c:c.join(",")})()}getParentIDs2Array(){var a=arguments,b=this;return l(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id");return yield b.getParentIDs(c,!0)})()}getParentIDs2ArrayWXID(){var a=arguments,b=this;return l(function*(){var c=0<a.length&&void 0!==a[0]?a[0]:b.throwIfMissing("id");return(yield b.getParentIDs(c,!0)).map(a=>{a.id})})()}tagParams(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",b=
2<arguments.length&&void 0!==arguments[2]?arguments[2]:!1,c=this.struct2params(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{});a=""!=c?"<".concat(a," ").concat(c):"<".concat(a);1==b&&(a+="/");return a+">"}struct2params(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.throwIfMissing("id"),b=[],c,d;for([c,d]of Object.entries(a))"object"!==typeof d&&"function"!==typeof d&&"undefined"!==typeof d&&b.push("".concat(c,"='").concat(d,"'"));return b.join(" ")}cleanIDs4node(){var a=
0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.throwIfMissing("node");delete a.id;return a}}return z})
